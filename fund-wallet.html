<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fund Wallet - Victor Cheap Data</title>
  <script src="https://checkout.flutterwave.com/v3.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen px-6 pt-10">
  <h2 class="text-xl font-bold mb-4">💳 Fund Wallet</h2>

  <label class="block mb-2 text-sm">Enter amount (NGN)</label>
  <input type="number" id="amount" class="w-full p-2 rounded text-black mb-4" placeholder="e.g. 2000" />

  <button onclick="payWithFlutterwave()" class="bg-cyan-500 w-full py-3 rounded font-bold text-white">
    Pay with Flutterwave
  </button>

  <script>
    async function payWithFlutterwave() {
      const amount = document.getElementById("amount").value;
      const token = localStorage.getItem("token");

      if (!amount || amount <= 0) {
        return alert("Enter a valid amount");
      }

      try {
        // Step 1: Get user details
        const profileRes = await fetch("https://victor-cheap-data-backend.onrender.com/api/auth/profile", {
          headers: {
            Authorization: "Bearer " + token
          }
        });

        const user = await profileRes.json();

        // Step 2: Open Flutterwave Checkout
        FlutterwaveCheckout({
          public_key: "9QpQqYQ1Cdcxzed6U39TjjDV10Tk0Qby", // ✅ Public key
          tx_ref: "Victor_" + Date.now(),
          amount: parseFloat(amount),
          currency: "NGN",
          payment_options: "card, banktransfer",
          customer: {
            email: user.email || "example@email.com",
            name: user.name || "Victor User",
          },
          callback: async function (response) {
            if (response.status === "successful") {
              // Step 3: Notify backend
              try {
                const confirmRes = await fetch("https://victor-cheap-data-backend.onrender.com/api/transaction/fund", {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                    Authorization: "Bearer " + token
                  },
                  body: JSON.stringify({
                    method: "flutterwave",
                    amount: amount
                  })
                });

                const confirmData = await confirmRes.json();

                if (confirmData.success) {
                  alert("✅ Wallet funded successfully!");
                  window.location.href = "dashboard.html";
                } else {
                  alert("⚠️ Payment succeeded but wallet not funded: " + (confirmData.message || "Check backend logs."));
                }
              } catch (err) {
                console.error("Error funding wallet:", err);
                alert("❌ Payment succeeded but wallet funding failed.");
              }
            } else {
              alert("❌ Payment not completed.");
            }
          },
          customizations: {
            title: "Victor Cheap Data",
            description: "Fund Wallet",
            logo: "https://your-logo-url.com/logo.png"
          }
        });

      } catch (err) {
        console.error("Error fetching profile:", err);
        alert("❌ Failed to fetch user profile. Please login again.");
      }
    }
  </script>
</body>
</html>
